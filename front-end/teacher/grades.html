<!--
Teacher can view enrolled students for their courses
Teacher can enter or update grades
Navigation back to Teacher Dashboard
Optional: simple table with columns: Student Name, Course, Grade
(Optional: Teacher Dashboard page)
Quick overview of courses assigned to them
Links to the grades page
--><!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Manage Grades - Teacher Dashboard</title>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
                font-family: 'Poppins', sans-serif;
            }
    
            body {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                min-height: 100vh;
                padding: 20px;
            }
    
            .container {
                max-width: 1200px;
                margin: 0 auto;
            }
    
            header {
                background: rgba(255, 255, 255, 0.95);
                padding: 20px 30px;
                border-radius: 15px;
                margin-bottom: 30px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 15px;
            }
    
            h1 {
                color: #333;
                font-size: 2rem;
            }
    
            .nav-links {
                display: flex;
                gap: 15px;
            }
    
            .nav-links a {
                color: #f5576c;
                text-decoration: none;
                padding: 8px 16px;
                border-radius: 8px;
                transition: background 0.3s;
            }
    
            .nav-links a:hover {
                background: #f0f0f0;
            }
    
            .course-selector {
                background: rgba(255, 255, 255, 0.95);
                padding: 20px 30px;
                border-radius: 15px;
                margin-bottom: 30px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }
    
            .course-selector label {
                display: block;
                margin-bottom: 10px;
                color: #333;
                font-weight: 600;
            }
    
            .course-selector select {
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1rem;
                background: white;
            }
    
            .grades-section {
                background: rgba(255, 255, 255, 0.95);
                border-radius: 15px;
                padding: 30px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }
    
            .grades-section h2 {
                color: #333;
                margin-bottom: 20px;
                font-size: 1.5rem;
            }
    
            .grades-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
    
            .grades-table th,
            .grades-table td {
                padding: 15px;
                text-align: left;
                border-bottom: 1px solid #eee;
            }
    
            .grades-table th {
                background: #f8f9fa;
                color: #333;
                font-weight: 600;
            }
    
            .grades-table tr:hover {
                background: #f8f9fa;
            }
    
            .grade-input {
                width: 100px;
                padding: 8px;
                border: 2px solid #ddd;
                border-radius: 6px;
                font-size: 0.9rem;
            }
    
            .grade-input:focus {
                outline: none;
                border-color: #f5576c;
            }
    
            .save-btn {
                padding: 8px 16px;
                background: #4CAF50;
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 0.9rem;
                font-weight: 600;
                cursor: pointer;
                transition: opacity 0.3s;
            }
    
            .save-btn:hover {
                opacity: 0.9;
            }
    
            .save-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
    
            .no-grade {
                color: #999;
                font-style: italic;
            }
    
            .message {
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
                text-align: center;
                font-weight: 500;
            }
    
            .message.success {
                background: #d4edda;
                color: #155724;
            }
    
            .message.error {
                background: #f8d7da;
                color: #721c24;
            }
    
            .loading {
                text-align: center;
                padding: 40px;
                color: white;
                font-size: 1.2rem;
            }
    
            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: #666;
            }
    
            .empty-state h3 {
                margin-bottom: 15px;
                color: #333;
            }
    
            .stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
    
            .stat-card {
                background: rgba(255, 255, 255, 0.95);
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                text-align: center;
            }
    
            .stat-card .number {
                font-size: 2.5rem;
                font-weight: 700;
                color: #f5576c;
                margin-bottom: 10px;
            }
    
            .stat-card .label {
                color: #666;
                font-size: 0.9rem;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>Manage Grades</h1>
                <div class="nav-links">
                    <a href="../courses/teacher_courses.html">My Courses</a>
                    <a href="../../index.html">Home</a>
                </div>
            </header>
    
            <div id="message"></div>
    
            <div class="course-selector">
                <label for="courseSelect">Select Course:</label>
                <select id="courseSelect" onchange="loadCourseGrades()">
                    <option value="">-- Select a course --</option>
                </select>
            </div>
    
            <div id="statsContainer" class="stats" style="display: none;">
                <div class="stat-card">
                    <div class="number" id="totalStudents">0</div>
                    <div class="label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="gradedStudents">0</div>
                    <div class="label">Graded Students</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="avgGrade">-</div>
                    <div class="label">Average Grade</div>
                </div>
            </div>
    
            <div class="grades-section" id="gradesSection" style="display: none;">
                <h2 id="courseTitle">Course Grades</h2>
                <div id="gradesContainer">
                    <div class="loading">Loading grades...</div>
                </div>
            </div>
        </div>
    
        <script src="../../back-end/teacher/teacher.js"></script>
        <script src="../../back-end/enrollment/enrollment.js"></script>
        <script src="../../back-end/courses/courses.js"></script>
        <script src="../../back-end/auth/auth.js"></script>
        <script>
            const authManager = new AuthManager();
            const courseManager = new CourseManager();
            const teacherManager = new TeacherManager();
            const currentUser = authManager.getCurrentUser();
    
            // Check authentication and role
            if (!currentUser) {
                window.location.href = '../auth/login.html';
            } else if (currentUser.role !== 'teacher') {
                window.location.href = '../courses/student_courses.html';
            }
    
            let currentCourseId = null;
            let currentGrades = [];
    
            // Load teacher's courses
            async function loadCourses() {
                try {
                    const courses = await courseManager.getCoursesByTeacher(currentUser.id);
                    const courseSelect = document.getElementById('courseSelect');
                    
                    if (courses.length === 0) {
                        courseSelect.innerHTML = '<option value="">No courses available</option>';
                        return;
                    }
    
                    courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.name;
                        courseSelect.appendChild(option);
                    });
    
                    // Check if courseId is in URL params
                    const urlParams = new URLSearchParams(window.location.search);
                    const courseId = urlParams.get('courseId');
                    if (courseId) {
                        courseSelect.value = courseId;
                        loadCourseGrades();
                    }
                } catch (error) {
                    showMessage('Error loading courses: ' + error.message, 'error');
                }
            }
    
            // Load grades for selected course
            async function loadCourseGrades() {
                const courseId = document.getElementById('courseSelect').value;
                
                if (!courseId) {
                    document.getElementById('gradesSection').style.display = 'none';
                    document.getElementById('statsContainer').style.display = 'none';
                    return;
                }
    
                currentCourseId = courseId;
    
                try {
                    const course = await courseManager.getCourseById(courseId);
                    if (course) {
                        document.getElementById('courseTitle').textContent = `Grades for ${course.name}`;
                    }
    
                    const grades = await teacherManager.getCourseGrades(courseId);
                    currentGrades = grades;
                    
                    displayGrades(grades);
                    updateStats(grades);
                    
                    document.getElementById('gradesSection').style.display = 'block';
                    document.getElementById('statsContainer').style.display = 'grid';
                } catch (error) {
                    showMessage('Error loading grades: ' + error.message, 'error');
                }
            }
    
            // Display grades in table
            function displayGrades(grades) {
                const container = document.getElementById('gradesContainer');
                
                if (grades.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No students enrolled in this course yet</h3></div>';
                    return;
                }
    
                container.innerHTML = `
                    <table class="grades-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Enrolled Date</th>
                                <th>Grade (%)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${grades.map((grade, index) => `
                                <tr>
                                    <td>${grade.studentName}</td>
                                    <td>${new Date(grade.enrolledAt).toLocaleDateString()}</td>
                                    <td>
                                        <input 
                                            type="number" 
                                            class="grade-input" 
                                            id="grade-${index}"
                                            value="${grade.grade !== null ? grade.grade : ''}"
                                            min="0" 
                                            max="100" 
                                            step="0.1"
                                            placeholder="Enter grade"
                                        >
                                    </td>
                                    <td>
                                        <button 
                                            class="save-btn" 
                                            onclick="saveGrade(${index}, '${grade.studentId}')"
                                        >
                                            Save
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
    
            // Save grade for a student
            async function saveGrade(index, studentId) {
                const gradeInput = document.getElementById(`grade-${index}`);
                const grade = gradeInput.value.trim();
                const saveBtn = gradeInput.parentElement.nextElementSibling.querySelector('.save-btn');
    
                if (!grade) {
                    showMessage('Please enter a grade', 'error');
                    return;
                }
    
                const gradeNum = parseFloat(grade);
                if (isNaN(gradeNum) || gradeNum < 0 || gradeNum > 100) {
                    showMessage('Grade must be a number between 0 and 100', 'error');
                    return;
                }
    
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
    
                try {
                    const result = await teacherManager.updateGrade(studentId, currentCourseId, gradeNum);
    
                    if (result.success) {
                        showMessage('Grade saved successfully!', 'success');
                        // Update the grade in currentGrades array
                        const gradeIndex = currentGrades.findIndex(g => g.studentId === studentId);
                        if (gradeIndex !== -1) {
                            currentGrades[gradeIndex].grade = gradeNum;
                        }
                        updateStats(currentGrades);
                    } else {
                        showMessage(result.message, 'error');
                    }
                } catch (error) {
                    showMessage('Error saving grade: ' + error.message, 'error');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                }
            }
    
            // Update statistics
            function updateStats(grades) {
                document.getElementById('totalStudents').textContent = grades.length;
                
                const graded = grades.filter(g => g.grade !== null && g.grade !== undefined);
                document.getElementById('gradedStudents').textContent = graded.length;
                
                if (graded.length > 0) {
                    const avg = (graded.reduce((a, b) => a + b.grade, 0) / graded.length).toFixed(1);
                    document.getElementById('avgGrade').textContent = avg + '%';
                } else {
                    document.getElementById('avgGrade').textContent = '-';
                }
            }
    
            // Show message
            function showMessage(text, type) {
                const messageDiv = document.getElementById('message');
                messageDiv.textContent = text;
                messageDiv.className = `message ${type}`;
                setTimeout(() => {
                    messageDiv.textContent = '';
                    messageDiv.className = '';
                }, 3000);
            }
    
            // Initialize
            loadCourses();
        </script>
    </body>
    </html>
    